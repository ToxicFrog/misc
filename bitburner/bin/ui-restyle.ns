function merge(dst, src) {
  Object.keys(src).forEach(function(key) {
    dst[key] = src[key];
  });
  return dst;
}

export async function main(ns) {
  if (window.restoreUI !== undefined) return;
  const wip_container = document.getElementById("work-in-progress-container");
  const wip_text = document.getElementById("work-in-progress-text");
  const main_menu = document.getElementById('mainmenu-container');

  merge(wip_container.style, {
    position: 'fixed', right: 0, bottom: 0,
    maxWidth: '280px', maxHeight: '60%',
    height: 'auto', width: '280px',
    overflowY: 'auto',
    border: '2px solid #FFFFFF',
    padding: '10px',
  });

  merge(wip_text.style, {
    width: '100%',
    margin: '0px',
    fontSize: '80%',
  });

  window.restoreUI = function(restore_active_pane, force_wip_display) {
    main_menu.style.visibility = 'visible';
    if (window.active_button && restore_active_pane) {
      window.active_button.click();
    }
    if (wip_text.innerText.trim().length > 0 || force_wip_display) {
      wip_container.style.display = 'block';
    }
  }

  // Saves the currently active tab, and calls restoreUI to redisplay the WIP panel if needed.
  window.saveUI = function() {
    window.active_button = this;
    window.restoreUI(false);
  }

  // Save the current UI state when clicking on one of the main menu buttons.
  for (let button of document.getElementById('mainmenu').getElementsByTagName('button')) {
    if (!button.classList.contains('mainmenu-accordion-header')) {
      button.addEventListener('click', window.saveUI);
    }
  }

  // Restore UI when clicking anywhere inside the WIP panel, or on the "cancel work" button.
  document.getElementById('work-in-progress-cancel-button').addEventListener(
    'click', window.restoreUI);
  wip_container.addEventListener('click', window.restoreUI);
  // Do the same for the "create program" buttons.
  [...document.getElementById('create-program-list').getElementsByTagName('a')].forEach(
    elem => elem.addEventListener('click', function() { window.restoreUI(true, true) }));
  // TODO: also handle the do crimes/do work buttons.
}
